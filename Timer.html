<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Timer with Multiple Routines</title>
  <style>
    #timer {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 20px;
    }
    input {
      font-size: 1.2em;
      padding: 5px;
      margin-right: 10px;
    }
    button {
      font-size: 1.2em;
      padding: 5px;
      margin-top: 10px;
    }
    .slider {
      width: 100%;
    }
    .workout-list {
      margin-top: 20px;
    }
    .workout-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .workout-item button {
      margin-left: 10px;
    }
    /* Highlight the active workout */
    .highlight {
      background-color: #dff0d8;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- Toggle Button -->
  <button onclick="toggleTopControls()">Show/Hide Controls</button>

  <!-- Wrapper for everything above the workout buttons -->
  <div id="topControls">
    <h2>Custom Workout Timer</h2>

    <div id="inputSection">
      <label for="workoutName">Workout Name: </label>
      <input type="text" id="workoutName" placeholder="Enter Workout Name">
      <label for="minuteInput">Enter minutes: </label>
      <input type="number" id="minuteInput" min="0" placeholder="Minutes">
      <label for="secondInput">Enter seconds: </label>
      <input type="number" id="secondInput" min="0" max="59" placeholder="Seconds">
      <label for="intervalInput">Enter interval (in seconds) to announce time: </label>
      <input type="number" id="intervalInput" min="1" placeholder="Interval in seconds">
      <button onclick="addWorkout()">Add Workout</button>
    </div>

    <div>
      <label for="speechSpeed">Adjust Speech Speed:</label>
      <input type="range" id="speechSpeed" class="slider" min="0.5" max="2" step="0.1" value="1">
      <span id="speedValue">1x</span>
      <br>
      <button onclick="exportWorkouts()">Export Workouts</button>
      <input type="file" id="importFile" onchange="importWorkouts(event)" style="display: none;">
      <button onclick="document.getElementById('importFile').click();">Import Workouts</button>
      <br><br>
    </div>
  </div>

  <!-- Workout Control Buttons (remain visible) -->
  <button onclick="startWorkout()">Start Workout Routine</button>
  <button onclick="resetWorkout()">Reset Workout</button>
  <button onclick="togglePause()">Pause/Resume Routine</button>
 

  <div id="timer"></div>
  <div class="workout-list">
    <h3>Workout Routines</h3>
    <ul id="workoutList"></ul>
  </div>



  <script>
    let workouts = JSON.parse(localStorage.getItem("workouts")) || [];
    let currentWorkoutIndex = 0;
    let timeRemaining = 0;
    let interval;
    let announceInterval = 0;
    let totalTime = 0;
    let timerRunning = false;
    let timeSinceLastSpeech = 0;
    let paused = false;
    let speechSpeed = 1;
    let startDelay = 10;
    let routinePaused = false;
    let editingIndex = null;

    // Function to speak the remaining time with minutes and seconds format
function speakTime(time) {
  window.speechSynthesis.cancel(); // Stop any ongoing speech

  let minutes = Math.floor(time / 60);
  let seconds = time % 60;
  let timeToAnnounce = '';

  if (time <= 20) {
    timeToAnnounce = `${seconds}`;
  } else {
    if (minutes > 0) {
      timeToAnnounce = `${minutes} minute${minutes > 1 ? 's' : ''} and ${seconds} second${seconds !== 1 ? 's' : ''}`;
    } else {
      timeToAnnounce = `${seconds} second${seconds !== 1 ? 's' : ''}`;
    }
  }

  const msg = new SpeechSynthesisUtterance(timeToAnnounce);
  msg.rate = speechSpeed;
  window.speechSynthesis.speak(msg);
}


    // Function to format the time in mm:ss format
    function formatTime(time) {
      const minutes = Math.floor(time / 60);
      const seconds = time % 60;
      return `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
    }

    // Function to update the timer
    function updateTimer() {
      if (isNaN(timeRemaining) || timeRemaining <= 0) {
        if (timeRemaining === 0) {
          document.getElementById("timer").textContent = "Time is up!";
          speakTime("Time is up!");
          clearInterval(interval);
          timerRunning = false;

          // Prepare for the next workout routine
          currentWorkoutIndex++;

          if (currentWorkoutIndex < workouts.length) {
            startNextWorkout();  // Start next workout when the current one finishes
          } else {
            document.getElementById("timer").textContent = "All workouts completed!";
          }
        }
      } else {
        // Countdown timer is still running
        if (startDelay > 0) {
          startDelay--;
        } else {
          if (timeRemaining >= 1) {
            if (timeRemaining <= 10) {
              speakTime(timeRemaining);
            } else if (timeSinceLastSpeech >= announceInterval) {
              speakTime(timeRemaining);
              timeSinceLastSpeech = 0;
            }
          }
        }

        // Decrease the remaining time by 1 second
        timeRemaining--;
        timeSinceLastSpeech++;
        document.getElementById("timer").textContent = `Time remaining: ${formatTime(timeRemaining)}`;
      }

      // If remaining time is less than or equal to 0, stop the timer and move to the next workout.
      if (timeRemaining <= 0) {
        // Exit the updateTimer function
        clearInterval(interval);
        timerRunning = false;

        // Start the next workout routine
        currentWorkoutIndex++;

        if (currentWorkoutIndex < workouts.length) {
          startNextWorkout();  // Start next workout
        } else {
          document.getElementById("timer").textContent = "All workouts completed!";
        }
      }
    }

    // Start the next workout in the routine
function startNextWorkout() {
  const workout = workouts[currentWorkoutIndex];
  announceInterval = workout.interval;
  totalTime = workout.minutes * 60 + workout.seconds;
  timeRemaining = totalTime;

  if (isNaN(timeRemaining) || timeRemaining <= 0) {
    alert("Invalid time for this workout.");
    return;
  }

  speakRoutineName(workout.name, () => {
    interval = setInterval(updateTimer, 1000);
    timerRunning = true;
    displayWorkouts();  // Update workout list highlight
  });
}


    // Function to announce the routine name
function speakRoutineName(routineName, callback) {
  const msg = new SpeechSynthesisUtterance(`Start ${routineName}`);
  msg.rate = speechSpeed;

  msg.onend = function () {
    if (typeof callback === 'function') {
      callback();
    }
  };

  window.speechSynthesis.speak(msg);
}

    // Add a new workout to the list
    function addWorkout() {
      const workoutName = document.getElementById("workoutName").value;
      const minutes = parseInt(document.getElementById("minuteInput").value) || 0;
      const seconds = parseInt(document.getElementById("secondInput").value) || 0;
      let interval = parseInt(document.getElementById("intervalInput").value);

      if (isNaN(interval) || interval <= 0) {
        interval = 20;
      }

      const totalTime = minutes * 60 + seconds;

      if (!workoutName || totalTime <= 0) {
        alert("Please fill out all fields correctly: Workout Name, Time.");
        return;
      }

      const workout = {
        name: workoutName,
        minutes: minutes,
        seconds: seconds,
        interval: interval
      };

      if (editingIndex === null) {
        workouts.push(workout); 
      } else {
        workouts[editingIndex] = workout;
        editingIndex = null;
      }

      saveWorkouts();
      displayWorkouts();
      resetInputs();
    }

    // Save workouts to localStorage
    function saveWorkouts() {
      localStorage.setItem("workouts", JSON.stringify(workouts));
    }

    // Display workouts in the list
    function displayWorkouts() {
      const workoutList = document.getElementById("workoutList");
      workoutList.innerHTML = '';

      workouts.forEach((workout, index) => {
        const li = document.createElement("li");
        li.className = "workout-item";

        // Add highlight class if it's the current workout
        if (index === currentWorkoutIndex && timerRunning) {
          li.classList.add("highlight");
        }

li.innerHTML = `
  <span>${workout.name}: ${workout.minutes}m ${workout.seconds}s, Interval: ${workout.interval}s</span>
  <button onclick="editWorkout(${index})">Edit</button>
  <button onclick="removeWorkout(${index})">Remove</button>
  <button onclick="moveUp(${index})">Up</button>
  <button onclick="moveDown(${index})">Down</button>
  <button onclick="copyWorkout(${index})">Copy</button> <!-- âœ… New -->
`;

        workoutList.appendChild(li);
      });
    }

    // Edit a workout from the list
    function editWorkout(index) {
      const workout = workouts[index];

      document.getElementById("workoutName").value = workout.name;
      document.getElementById("minuteInput").value = workout.minutes;
      document.getElementById("secondInput").value = workout.seconds;
      document.getElementById("intervalInput").value = workout.interval;

      const addButton = document.querySelector("button[onclick='addWorkout()']");
      addButton.textContent = "Save Edit";
      addButton.setAttribute("onclick", `addWorkout()`);

      editingIndex = index;
    }

    // Remove a workout from the list
    function removeWorkout(index) {
      workouts.splice(index, 1);
      saveWorkouts();
      displayWorkouts();
    }

    // Move workout up in the list
    function moveUp(index) {
      if (index > 0) {
        const temp = workouts[index];
        workouts[index] = workouts[index - 1];
        workouts[index - 1] = temp;
        saveWorkouts();
        displayWorkouts();
      }
    }

    // Move workout down in the list
    function moveDown(index) {
      if (index < workouts.length - 1) {
        const temp = workouts[index];
        workouts[index] = workouts[index + 1];
        workouts[index + 1] = temp;
        saveWorkouts();
        displayWorkouts();
      }
    }

    // Reset the inputs after adding/editing a workout
    function resetInputs() {
      document.getElementById("workoutName").value = '';
      document.getElementById("minuteInput").value = '';
      document.getElementById("secondInput").value = '';
      document.getElementById("intervalInput").value = '';
    }

    // Start the workout routine
    function startWorkout() {
      if (workouts.length === 0) {
        alert("Please add some routines first!");
        return;
      }
      if (timerRunning) {
  alert("A routine is already running. Please reset before starting a new one.");
  return;
}

      currentWorkoutIndex = 0;
toggleTopControls();
      startNextWorkout();
    }

    // Reset the workout routine
    function resetWorkout() {
      clearInterval(interval);
      document.getElementById("timer").textContent = "";
      currentWorkoutIndex = 0;
      timerRunning = false;
      routinePaused = false;
      window.speechSynthesis.cancel();

    }

    // Toggle pause/resume
function togglePause() {
  const pauseBtn = document.querySelector("button[onclick='togglePause()']");
  if (routinePaused) {
    interval = setInterval(updateTimer, 1000);
    routinePaused = false;
    pauseBtn.textContent = "Pause Routine";
  } else {
    clearInterval(interval);
    routinePaused = true;
    pauseBtn.textContent = "Resume Routine";
  }
}


    // Initialize the app
    displayWorkouts();

    // Listen for changes to the speech speed slider and update the speed
    document.getElementById('speechSpeed').addEventListener('input', function() {
      speechSpeed = parseFloat(this.value);
      document.getElementById('speedValue').textContent = `${speechSpeed}x`;
    });
    
    
// Export workouts to JSON file
function exportWorkouts() {
  const workoutsData = JSON.stringify(workouts, null, 2); // Convert workouts array to a formatted JSON string
  const blob = new Blob([workoutsData], { type: 'application/json' }); // Create a Blob with JSON data
  const url = URL.createObjectURL(blob); // Create a URL for the Blob

  // Create an anchor element to download the file
  const a = document.createElement('a');
  a.href = url;
  a.download = 'workouts.json'; // Default filename for the export
  a.click();

  // Clean up by revoking the Blob URL
  URL.revokeObjectURL(url);
}

// Import workouts from a JSON file
function importWorkouts(event) {
  const file = event.target.files[0]; // Get the uploaded file
  const reader = new FileReader();

  reader.onload = function() {
    try {
      const importedWorkouts = JSON.parse(reader.result); // Parse the JSON string into an array
      if (Array.isArray(importedWorkouts)) {
        workouts = importedWorkouts; // Replace current workouts with the imported ones
        saveWorkouts(); // Save to localStorage
        displayWorkouts(); // Update the displayed workouts list
      } else {
        alert("The uploaded file is not a valid workouts JSON.");
      }
    } catch (e) {
      alert("Error parsing the file. Please ensure it's a valid JSON file.");
    }
  };

  if (file) {
    reader.readAsText(file); // Read the file as text
  }
}


function copyWorkout(index) {
  const workoutToCopy = workouts[index];

  const copiedWorkout = {
    name: workoutToCopy.name + "",
    minutes: workoutToCopy.minutes,
    seconds: workoutToCopy.seconds,
    interval: workoutToCopy.interval
  };

  workouts.splice(index + 1, 0, copiedWorkout); // Insert after the original
  saveWorkouts();
  displayWorkouts();
}

function toggleTopControls() {
  const controls = document.getElementById('topControls');
  controls.style.display = controls.style.display === 'none' ? 'block' : 'none';
}


  </script>

</body>
</html>
